# Memory ordering



## Wikipedia [Memory ordering](https://infogalactic.com/info/Memory_ordering)

**Memory ordering** describes the order of accesses to computer memory by a CPU. The term can refer either to the memory ordering generated by the [compiler](https://infogalactic.com/info/Compiler) during [compile time](https://infogalactic.com/info/Compile_time), or to the memory ordering generated by a CPU during [runtime](https://infogalactic.com/info/Run_time_(program_lifecycle_phase)).

> NOTE: compiler time和runtime

In modern [microprocessors](https://infogalactic.com/info/Microprocessor), memory ordering characterizes the CPUs ability to reorder memory operations - it is a type of [out-of-order execution](https://infogalactic.com/info/Out-of-order_execution). Memory reordering can be used to fully utilize the bus-bandwidth of different types of memory such as [caches](https://infogalactic.com/info/CPU_cache#Cache_entries) and [memory banks](https://infogalactic.com/info/Memory_bank).

> NOTE: CPU的一种优化方式

On most modern uniprocessors memory operations are **not** executed in the order specified by the program code.

> NOTE: 这是一个重要事实，可能与我们的直觉相违背

In single threaded programs all operations appear to have been executed in the order specified, with all out-of-order execution hidden to the programmer – however in multi-threaded environments (or when interfacing with other hardware via memory buses) this can lead to problems. 

> NOTE: ordering对programmer是透明的。multi-threaded environments中的一个典型问题就是使用 [Double-checked locking](https://infogalactic.com/info/Double-checked_locking) 来实现 [Singleton pattern](https://infogalactic.com/info/Singleton_pattern). 

To avoid problems [memory barriers](https://infogalactic.com/info/Memory_barrier) can be used in these cases.

### Compile-time memory ordering

The [compiler](https://infogalactic.com/info/Compiler) has some freedom to resort the order of operations during [compile time](https://infogalactic.com/info/Compile_time). However this can lead to problems if the order of memory accesses is of importance.

> NOTE: 原文中关于[Memory barrier](https://infogalactic.com/info/Memory_barrier)的讨论放到了工程parallel-computing的`Concurrent-computing\Concurrency-control\Non-blocking\Memory-barrier`章节。



### Runtime memory ordering

#### In symmetric multiprocessing (SMP) microprocessor systems

There are several **memory-consistency models** for [SMP](https://infogalactic.com/info/Symmetric_multiprocessing) systems:

- Sequential consistency (all reads and all writes are in-order)
- Relaxed consistency (some types of reordering are allowed)
  - Loads can be reordered after loads (for better working of cache coherency, better scaling)
  - Loads can be reordered after stores
  - Stores can be reordered after stores
  - Stores can be reordered after loads
- Weak consistency (reads and writes are arbitrarily reordered, limited only by explicit [memory barriers](https://infogalactic.com/info/Memory_barrier))



> NOTE: 原文中关于[Memory barrier](https://infogalactic.com/info/Memory_barrier)的讨论放到了工程parallel-computing的`Concurrent-computing\Concurrency-control\Non-blocking\Memory-barrier`章节。