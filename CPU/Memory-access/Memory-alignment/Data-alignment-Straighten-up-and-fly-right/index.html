



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Project documentation with Markdown.">
      
      
        <link rel="canonical" href="https://dengking.github.io/Hardware/CPU/Memory-access/Memory-alignment/Data-alignment-Straighten-up-and-fly-right/">
      
      
        <meta name="author" content="DengKing">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Data-alignment-Straighten-up-and-fly-right - Hardware</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../../../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../../css/extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-27795084-5", "mkdocs.org")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#data-alignment-straighten-up-and-fly-right" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://dengking.github.io/Hardware" title="Hardware" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Hardware
            </span>
            <span class="md-header-nav__topic">
              
                Data-alignment-Straighten-up-and-fly-right
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/dengking/Hardware" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://dengking.github.io/Hardware" title="Hardware" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Hardware
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/dengking/Hardware" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Book-计算机组成原理-科学出版社
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Book-计算机组成原理-科学出版社
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      第一章-计算机系统概述
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        第一章-计算机系统概述
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Book-计算机组成原理-科学出版社/第一章-计算机系统概述/1.2-计算机的发展简史/" title="1.2-计算机的发展简史" class="md-nav__link">
      1.2-计算机的发展简史
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../Book-计算机组成原理-科学出版社/第一章-计算机系统概述/1.3-计算机硬件/" title="1.3-计算机硬件" class="md-nav__link">
      1.3-计算机硬件
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      CPU
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        CPU
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Processor(computing)/" title="Processor(computing)" class="md-nav__link">
      Processor(computing)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Central-processing-unit/" title="Central-processing-unit" class="md-nav__link">
      Central-processing-unit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Instruction-set-architectures
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Instruction-set-architectures
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Instruction-set-architectures/Instruction-set-architecture/" title="Instruction-set-architecture" class="md-nav__link">
      Instruction-set-architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Instruction-set-architectures/Machine-code/" title="Machine-code" class="md-nav__link">
      Machine-code
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      Components
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Components
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Components/Control-unit/" title="Control-unit" class="md-nav__link">
      Control-unit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-2" type="checkbox" id="nav-3-4-2">
    
    <label class="md-nav__link" for="nav-3-4-2">
      Processor-register
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-2">
        Processor-register
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Components/Register/Program-counter/" title="Program-counter" class="md-nav__link">
      Program-counter
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Components/Register/Stack-register/" title="Stack-register" class="md-nav__link">
      Stack-register
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5" checked>
    
    <label class="md-nav__link" for="nav-3-5">
      Memory-access
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Memory-access
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Memory–access/" title="Memory–access" class="md-nav__link">
      Memory–access
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-3" type="checkbox" id="nav-3-5-3" checked>
    
    <label class="md-nav__link" for="nav-3-5-3">
      Memory-alignment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-3">
        Memory-alignment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Data-alignment-Straighten-up-and-fly-right
      </label>
    
    <a href="./" title="Data-alignment-Straighten-up-and-fly-right" class="md-nav__link md-nav__link--active">
      Data-alignment-Straighten-up-and-fly-right
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memory-access-granularity" class="md-nav__link">
    Memory access granularity
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alignment-fundamentals" class="md-nav__link">
    Alignment fundamentals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazy-processors" class="md-nav__link">
    Lazy processors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#speed" class="md-nav__link">
    Speed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#atomicity" class="md-nav__link">
    Atomicity
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#altivec" class="md-nav__link">
    Altivec
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#structure-alignment" class="md-nav__link">
    Structure alignment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credits" class="md-nav__link">
    Credits
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Memory-alignment/" title="Memory-alignment" class="md-nav__link">
      Memory-alignment
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Instruction-cycle/" title="Instruction-cycle" class="md-nav__link">
      Instruction-cycle
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-7" type="checkbox" id="nav-3-7">
    
    <label class="md-nav__link" for="nav-3-7">
      Word
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-7">
        Word
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Word/Word(computer-architecture)/" title="Word(computer-architecture)" class="md-nav__link">
      Word(computer-architecture)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-8" type="checkbox" id="nav-3-8">
    
    <label class="md-nav__link" for="nav-3-8">
      Assembly-language
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-8">
        Assembly-language
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Assembly-language/Assembly-language/" title="Assembly-language" class="md-nav__link">
      Assembly-language
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-9" type="checkbox" id="nav-3-9">
    
    <label class="md-nav__link" for="nav-3-9">
      Intel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-9">
        Intel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Intel/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-9-2" type="checkbox" id="nav-3-9-2">
    
    <label class="md-nav__link" for="nav-3-9-2">
      X86-instruction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-9-2">
        X86-instruction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Intel/X86-instruction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Intel/X86-instruction/INT/" title="INT" class="md-nav__link">
      INT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-9-2-3" type="checkbox" id="nav-3-9-2-3">
    
    <label class="md-nav__link" for="nav-3-9-2-3">
      Book-X86-assembly
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-9-2-3">
        Book-X86-assembly
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Intel/X86-instruction/Book-X86-assembly/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memory-access-granularity" class="md-nav__link">
    Memory access granularity
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alignment-fundamentals" class="md-nav__link">
    Alignment fundamentals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazy-processors" class="md-nav__link">
    Lazy processors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#speed" class="md-nav__link">
    Speed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#atomicity" class="md-nav__link">
    Atomicity
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#altivec" class="md-nav__link">
    Altivec
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#structure-alignment" class="md-nav__link">
    Structure alignment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credits" class="md-nav__link">
    Credits
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="data-alignment-straighten-up-and-fly-right"><a href="https://developer.ibm.com/articles/pa-dalign/">Data alignment: Straighten up and fly right</a></h1>
<blockquote>
<p>NOTE: 本文给出了memory access详细细节以及相关问题。其中的<em>memory access granularity</em>概念尤其重要，结合前面章节的内容，在此可以预告读者目前大多数CPU的<em>memory access granularity</em>取<a href="https://en.wikipedia.org/wiki/Word_(computer_architecture)">word size</a>。</p>
</blockquote>
<h2 id="memory-access-granularity">Memory access granularity</h2>
<p>Programmers are conditioned to think of memory as a simple array of bytes. Among C and its descendants, <code>char*</code> is ubiquitous(普遍存在的) as meaning “a block of memory”, and even Java™ has its <code>byte[]</code> type to represent raw memory.</p>
<p>Figure 1. How programmers see memory</p>
<p><img alt="How Programmers See Memory" src="https://developer.ibm.com/developer/articles/pa-dalign/images/howProgrammersSeeMemory.jpg" /></p>
<p>However, your computer’s processor does not read from and write to memory in byte-sized chunks. Instead, it accesses memory in two-, four-, eight- 16- or even 32-byte chunks. We’ll call the size in which a <strong>processor</strong> accesses memory its <em>memory access granularity</em>.</p>
<blockquote>
<p>NOTE: 需要理解granularity的含义，它的中文意思是<strong>粒度</strong>，可以把它看做是<strong>单位</strong>的意思，它具有<strong>原子性</strong>。<strong>memory access granularity</strong>是CPU从memory中读取数据的<strong>单位</strong>，所以CPU无法从memory中读取半个单位的数据，只能够读取一个单位的数据。下面的Figure 2就非常直观地展示了CPU视角的memory。通过前面的这些分析，我们应该知道的是，CPU只能够从位置<code>0</code>、<code>4</code>、<code>8</code>等位置开始读取数据，这些位置我们通常将它们称为memory access boundary（在后续章节会介绍），显然CPU access boundary是<strong>memory access granularity</strong>的整数倍，如果一个数据的存储位置是memory access boundary，则称为<strong>align to memory access granularity</strong>（对齐），使用aligned来形容这样的地址，否则就是unaligned。通过后面的章节，我们会看到，aligned address相比于unaligned address有着诸多优势。</p>
</blockquote>
<p>Figure 2. How processors see memory</p>
<p><img alt="How Some Processors See Memory" src="https://developer.ibm.com/developer/articles/pa-dalign/images/howProcessorsSeeMemory.jpg" /></p>
<p>If you don’t understand and address alignment issues in your software, the following scenarios, in increasing order of severity, are all possible:</p>
<ul>
<li>Your software will run slower.</li>
<li>Your application will lock up.</li>
<li>Your operating system will crash.</li>
<li>Your software will silently fail, yielding incorrect results.</li>
</ul>
<h2 id="alignment-fundamentals">Alignment fundamentals</h2>
<p>To illustrate the principles behind alignment, examine a constant task, and how it’s affected by a processor’s <strong>memory access granularity</strong>. The task is simple: first read four bytes from address 0 into the processor’s register. Then read four bytes from address 1 into the same register.</p>
<p>First examine what would happen on a processor with a one-byte memory access granularity:</p>
<p>Figure 3. Single-byte memory access granularity</p>
<p><img alt="Single-byte memory access granularity" src="https://developer.ibm.com/developer/articles/pa-dalign/images/singleByteAccess.jpg" /></p>
<p>This fits in with the naive programmer’s model of how memory works: it takes the same four memory accesses to read from address 0 as it does from address 1. Now see what would happen on a processor with two-byte granularity, like the original 68000:</p>
<p>Figure 4. Double-byte memory access granularity</p>
<p><img alt="Double-byte memory access granularity" src="https://developer.ibm.com/developer/articles/pa-dalign/images/doubleByteAccess.jpg" /></p>
<p>When reading from address 0, a processor with two-byte granularity takes half the number of memory accesses as a processor with one-byte granularity. Because each memory access entails a fixed amount overhead, minimizing the number of accesses can really help performance.</p>
<blockquote>
<p>NOTE: 这句话的意思是a processor with two-byte granularity读取4个字节花费的时间比a processor with one-byte granularity花费的时间要少一半；</p>
</blockquote>
<p>However, notice what happens when reading from address 1. Because the address doesn’t fall evenly on the processor’s <strong>memory access boundary</strong>, the processor has extra work to do. Such an address is known as an <em>unaligned address</em>. Because address 1 is <strong>unaligned</strong>, a processor with two-byte granularity must perform an extra memory access, slowing down the operation</p>
<p>Finally, examine what would happen on a processor with four-byte memory access granularity, like the 68030 or PowerPC® 601:</p>
<p>Figure 5. Quad-byte memory access granularity</p>
<p><img alt="Quad-byte memory access granularity" src="https://developer.ibm.com/developer/articles/pa-dalign/images/quadByteAccess.jpg" /></p>
<p>A processor with four-byte granularity can slurp up four bytes from an aligned address with one read. Also note that reading from an <strong>unaligned address</strong> doubles the access count.</p>
<p>Now that you understand the fundamentals behind <strong>aligned data access</strong>, you can explore some of the issues related to alignment.   </p>
<h2 id="lazy-processors">Lazy processors</h2>
<p>A processor has to perform some tricks when instructed to access an <strong>unaligned address</strong>. Going back to the example of reading four bytes from address 1 on a processor with <strong>four-byte granularity</strong>, you can work out exactly what needs to be done:</p>
<p>Figure 6. How processors handle unaligned memory access</p>
<p><img alt="How processors handle unaligned memory access" src="https://developer.ibm.com/developer/articles/pa-dalign/images/unalignedAccess.jpg" /></p>
<p>The processor needs to read the first chunk of the unaligned address and shift out the “unwanted” bytes from the first chunk. Then it needs to read the second chunk of the unaligned address and shift out some of its information. Finally, the two are merged together for placement in the register. It’s a lot of work.</p>
<p>Some processors just aren’t willing to do all of that work for you.</p>
<p>The original 68000 was a processor with two-byte granularity and lacked the circuitry to cope with <strong>unaligned addresses</strong>. When presented with such an address, the processor would throw an exception. The original Mac OS didn’t take very kindly to this exception, and would usually demand the user restart the machine. Ouch.</p>
<p>Later processors in the 680×0 series, such as the 68020, lifted this restriction and performed the necessary work for you. This explains why some old software that works on the 68020 crashes on the 68000. It also explains why, way back when, some old Mac coders initialized pointers with odd addresses. On the original Mac, if the pointer was accessed without being reassigned to a valid address, the Mac would immediately drop into the debugger. Often they could then examine the calling chain stack and figure out where the mistake was.</p>
<p>All processors have a finite number of transistors to get work done. Adding <strong>unaligned address access</strong> support cuts into this “transistor budget.” These transistors could otherwise be used to make other portions of the processor work faster, or add new functionality altogether.</p>
<p>An example of a processor that sacrifices <strong>unaligned address access support</strong> in the name of <strong>speed</strong> is MIPS. MIPS is a great example of a processor that does away with almost all frivolity in the name of getting real work done faster.</p>
<p>The PowerPC takes a hybrid approach. Every PowerPC processor to date has hardware support for unaligned 32-bit integer access. While you still pay a performance penalty for unaligned access, it tends to be small.</p>
<p>On the other hand, modern PowerPC processors lack hardware support for unaligned 64-bit floating-point access. When asked to load an unaligned floating-point number from memory, modern PowerPC processors will throw an exception and have the operating system perform the alignment chores <em>in software</em>. Performing alignment in software is <em>much</em> slower than performing it in hardware.</p>
<blockquote>
<p>NOTE : 有的processor压根就不支持unaligned address access </p>
</blockquote>
<h2 id="speed">Speed</h2>
<p>Writing some tests illustrates the performance penalties of <strong>unaligned memory access</strong>. The test is simple: you read, negate, and write back the numbers in a ten-megabyte buffer. These tests have two variables:</p>
<ol>
<li><strong>The size, in bytes, in which you process the buffer.</strong> First you’ll process the buffer one byte at a time. Then you’ll move onto two-, four- and eight-bytes at a time.</li>
<li><strong>The alignment of the buffer.</strong> You’ll stagger the alignment of the buffer by incrementing the pointer to the buffer and running each test again.</li>
</ol>
<p>These tests were performed on a 800 MHz PowerBook G4. To help normalize performance fluctuations from interrupt processing, each test was run ten times, keeping the average of the runs. First up is the test that operates on a single byte at a time:</p>
<p>Listing 1. Munging data one byte at a time</p>
<pre><code class="c">void Munge8( void ∗data, uint32_t size ) {
    uint8_t ∗data8 = (uint8_t∗) data;
    uint8_t ∗data8End = data8 + size;

    while( data8 != data8End ) {
        ∗data8++ = ‑∗data8;
    }
}
</code></pre>

<p>It took an average of 67,364 microseconds to execute this function. Now modify it to work on two bytes at a time instead of one byte at a time — which will halve the number of memory accesses:</p>
<p>Listing 2. Munging data two bytes at a time</p>
<pre><code class="c">void Munge16( void ∗data, uint32_t size ) {
    uint16_t ∗data16 = (uint16_t∗) data;
    uint16_t ∗data16End = data16 + (size &gt;&gt; 1); /∗ Divide size by 2. ∗/
    uint8_t ∗data8 = (uint8_t∗) data16End;
    uint8_t ∗data8End = data8 + (size &amp; 0x00000001); /∗ Strip upper 31 bits. ∗/

    while( data16 != data16End ) {
        ∗data16++ = ‑∗data16;
    }
    while( data8 != data8End ) {
        ∗data8++ = ‑∗data8;
    }
}
</code></pre>

<p>This function took 48,765 microseconds to process the same ten-megabyte buffer — 38% faster than <code>Munge8</code>. However, that buffer was aligned. If the buffer is unaligned, the time required increases to 66,385 microseconds — about a 27% speed penalty. The following chart illustrates the performance pattern of aligned memory accesses versus unaligned accesses:</p>
<p>Figure 7. Single-byte access versus double-byte access</p>
<p><img alt="Single-byte access versus double-byte access" src="https://developer.ibm.com/developer/articles/pa-dalign/images/doubleChart.jpg" /></p>
<p>The first thing you notice is that accessing memory one byte at a time is uniformly slow. The second item of interest is that when accessing memory two bytes at a time, whenever the address is not evenly divisible by two, that 27% speed penalty rears its ugly head.</p>
<p>Now up the ante, and process the buffer four bytes at a time:</p>
<p>Listing 3. Munging data four bytes at a time</p>
<pre><code class="c">void Munge32( void ∗data, uint32_t size ) {
    uint32_t ∗data32 = (uint32_t∗) data;
    uint32_t ∗data32End = data32 + (size &gt;&gt; 2); /∗ Divide size by 4. ∗/
    uint8_t ∗data8 = (uint8_t∗) data32End;
    uint8_t ∗data8End = data8 + (size &amp; 0x00000003); /∗ Strip upper 30 bits. ∗/

    while( data32 != data32End ) {
        ∗data32++ = ‑∗data32;
    }
    while( data8 != data8End ) {
        ∗data8++ = ‑∗data8;
    }
}
</code></pre>

<p>This function processes an aligned buffer in 43,043 microseconds and an unaligned buffer in 55,775 microseconds, respectively. Thus, on this test machine, accessing unaligned memory four bytes at a time is <em>slower</em> than accessing aligned memory two bytes at a time:</p>
<p>Figure 8. Single- versus double- versus quad-byte access</p>
<p><img alt="Single- versus double- versus quad-byte access" src="https://developer.ibm.com/developer/articles/pa-dalign/images/quadChart.jpg" /></p>
<p>Now for the horror story: processing the buffer eight bytes at a time.</p>
<p>Listing 4. Munging data eight bytes at a time</p>
<pre><code class="c">void Munge64( void ∗data, uint32_t size ) {
    double ∗data64 = (double∗) data;
    double ∗data64End = data64 + (size &gt;&gt; 3); /∗ Divide size by 8. ∗/
    uint8_t ∗data8 = (uint8_t∗) data64End;
    uint8_t ∗data8End = data8 + (size &amp; 0x00000007); /∗ Strip upper 29 bits. ∗/

    while( data64 != data64End ) {
        ∗data64++ = ‑∗data64;
    }
    while( data8 != data8End ) {
        ∗data8++ = ‑∗data8;
    }
}
</code></pre>

<p><code>Munge64</code> processes an aligned buffer in 39,085 microseconds — about 10% faster than processing the buffer four bytes at a time. However, processing an unaligned buffer takes an amazing 1,841,155 microseconds — two orders of magnitude slower than aligned access, an outstanding 4,610% performance penalty!</p>
<p>What happened? Because modern PowerPC processors lack hardware support for unaligned floating-point access, the processor throws an exception <em>for each unaligned access.</em> The operating system catches this exception and performs the alignment in software. Here’s a chart illustrating the penalty, and when it occurs:</p>
<p>Figure 9. Multiple-byte access comparison</p>
<p><img alt="Multiple-byte access comparison" src="https://developer.ibm.com/developer/articles/pa-dalign/images/horrorChartWhole.jpg" /></p>
<p>The penalties for one-, two- and four-byte unaligned access are dwarfed by the horrendous unaligned eight-byte penalty. Maybe this chart, removing the top (and thus the tremendous gulf between the two numbers), will be clearer:</p>
<p>Figure 10. Multiple-byte access comparison #2</p>
<p><img alt="Multiple-byte access comparison #2" src="https://developer.ibm.com/developer/articles/pa-dalign/images/horrorChartHeadless.jpg" /></p>
<p>There’s another subtle insight hidden in this data. Compare eight-byte access speeds on four-byte boundaries:</p>
<p>Figure 11. Multiple-byte access comparison #3</p>
<p><img alt="Multiple-byte access comparison #3" src="https://developer.ibm.com/developer/articles/pa-dalign/images/horrorChartHeadlessHilited.jpg" /></p>
<p>Notice accessing memory eight bytes at a time on four- and twelve- byte boundaries <em>is slower</em> than reading the same memory four or even two bytes at a time. While PowerPCs have hardware support for four-byte aligned eight-byte doubles, you still pay a performance penalty if you use that support. Granted, it’s no where near the 4,610% penalty, but it’s certainly noticeable. Moral of the story: accessing memory in large chunks can be slower than accessing memory in small chunks, if that access is not aligned.</p>
<h2 id="atomicity">Atomicity</h2>
<p>All modern processors offer <strong>atomic instructions</strong>. These special instructions are crucial for synchronizing two or more concurrent tasks. As the name implies, atomic instructions must be <em>indivisible</em> — that’s why they’re so handy for synchronization: they can’t be preempted.</p>
<p>It turns out that in order for atomic instructions to perform correctly, the addresses you pass them must be at least four-byte aligned. This is because of a subtle interaction between <strong>atomic instructions</strong> and <strong>virtual memory</strong>.</p>
<p>If an address is unaligned, it requires at least two memory accesses. But what happens if the desired data spans <strong>two pages</strong> of <strong>virtual memory</strong>? This could lead to a situation where the first page is resident while the last page is not. Upon access, in the middle of the instruction, a <strong>page fault</strong> would be generated, executing the virtual memory management swap-in code, destroying the <strong>atomicity of the instruction</strong>. To keep things simple and correct, both the 68K and PowerPC require that atomically manipulated addresses always be at least four-byte aligned.</p>
<p>Unfortunately, the PowerPC does not throw an exception when atomically storing to an unaligned address. Instead, the store simply always fails. This is bad because most atomic functions are written to retry upon a failed store, under the assumption they were preempted. These two circumstances combine to where your program will go into an infinite loop if you attempt to atomically store to an unaligned address. Oops.</p>
<h2 id="altivec">Altivec</h2>
<p>Altivec is all about speed. <strong>Unaligned memory access</strong> slows down the processor and costs precious transistors. Thus, the Altivec engineers took a page from the MIPS playbook and simply don’t support unaligned memory access. Because Altivec works with sixteen-byte chunks at a time, all addresses passed to Altivec must be sixteen-byte aligned. What’s scary is what happens if your address is not aligned.</p>
<p>Altivec won’t throw an exception to warn you about the unaligned address. Instead, Altivec simply ignores the lower four bits of the address and charges ahead, <em>operating on the wrong address</em>. This means your program may silently corrupt memory or return incorrect results if you don’t explicitly make sure all your data is aligned.</p>
<p>There is an advantage to Altivec’s bit-stripping ways. Because you don’t need to explicitly truncate (align-down) an address, this behavior can save you an instruction or two when handing addresses to the processor.</p>
<p>This is not to say Altivec can’t process unaligned memory. You can find detailed instructions how to do so on the <em>Altivec Programming Environments Manual</em> (see resources on the right). It requires more work, but because memory is so slow compared to the processor, the overhead for such shenanigans is surprisingly low.</p>
<h2 id="structure-alignment">Structure alignment</h2>
<p>Examine the following structure:</p>
<p>Listing 5. An innocent structure</p>
<pre><code class="c">void Munge64( void ∗data, uint32_t size ) {
typedef struct {
    char    a;
    long    b;
    char    c;
}   Struct;
</code></pre>

<p>What is the size of this structure in bytes? Many programmers will answer “6 bytes.” It makes sense: one byte for <code>a</code>, four bytes for <code>b</code> and another byte for <code>c</code>. 1 + 4 + 1 equals 6. Here’s how it would lay out in memory:</p>
<p>Table 1. Structure size in bytes</p>
<table>
<thead>
<tr>
<th align="left">Field Type</th>
<th align="left">Field Name</th>
<th align="left">Field Offset</th>
<th align="left">Field Size</th>
<th align="left">Field End</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>char</code></td>
<td align="left"><code>a</code></td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left"><code>long</code></td>
<td align="left"><code>b</code></td>
<td align="left">1</td>
<td align="left">4</td>
<td align="left">5</td>
</tr>
<tr>
<td align="left"><code>char</code></td>
<td align="left"><code>c</code></td>
<td align="left">5</td>
<td align="left">1</td>
<td align="left">6</td>
</tr>
<tr>
<td align="left">Total size in bytes:</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">6</td>
</tr>
</tbody>
</table>
<p>However, if you were to ask your compiler to <code>sizeof( Struct )</code>, chances are the answer you’d get back would be greater than six, perhaps eight or even twenty-four. There’s two reasons for this: backwards compatibility and efficiency.</p>
<p>First, backwards compatibility. Remember the 68000 was a processor with two-byte memory access granularity, and would throw an exception upon encountering an odd address. If you were to read from or write to field <code>b</code>, you’d attempt to access an odd address. If a debugger weren’t installed, the old Mac OS would throw up a System Error dialog box with one button: Restart. Yikes!</p>
<p>So, instead of laying out your fields just the way you wrote them, the compiler <em>padded</em> the structure so that <code>b</code> and <code>c</code> would reside at even addresses:</p>
<p>Table 2. Structure with compiler padding</p>
<table>
<thead>
<tr>
<th align="left">Field Type</th>
<th align="left">Field Name</th>
<th align="left">Field Offset</th>
<th align="left">Field Size</th>
<th align="left">Field End</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>char</code></td>
<td align="left"><code>a</code></td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><em>padding</em></td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left"><code>long</code></td>
<td align="left"><code>b</code></td>
<td align="left">2</td>
<td align="left">4</td>
<td align="left">6</td>
</tr>
<tr>
<td align="left"><code>char</code></td>
<td align="left"><code>c</code></td>
<td align="left">6</td>
<td align="left">1</td>
<td align="left">7</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><em>padding</em></td>
<td align="left">7</td>
<td align="left">1</td>
<td align="left">8</td>
</tr>
<tr>
<td align="left">Total Size in Bytes:</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">8</td>
</tr>
</tbody>
</table>
<p>Padding is the act of adding otherwise unused space to a structure to make fields line up in a desired way. Now, when the 68020 came out with built-in hardware support for unaligned memory access, this padding was unnecessary. However, it didn’t hurt anything, and it even helped a little in performance.</p>
<p>The second reason is efficiency. Nowadays, on PowerPC machines, two-byte alignment is nice, but four-byte or eight-byte is better. You probably don’t care anymore that the original 68000 choked on unaligned structures, but you probably care about potential 4,610% performance penalties, which can happen if a <code>double</code> field doesn’t sit aligned in a structure of your devising.</p>
<h2 id="conclusion">Conclusion</h2>
<p>If you don’t understand and explicitly code for data alignment:</p>
<ul>
<li>Your software may hit performance-killing unaligned memory access exceptions, which invoke <em>very</em> expensive alignment exception handlers.</li>
<li>Your application may attempt to atomically store to an unaligned address, causing your application to lock up.</li>
<li>Your application may attempt to pass an unaligned address to Altivec, resulting in Altivec reading from and/or writing to the wrong part of memory, silently corrupting data or yielding incorrect results.</li>
</ul>
<h2 id="credits">Credits</h2>
<p>Thanks to Alex Rosenberg and Ian Ollmann for feedback, Matt Slot for his FastTimes timing library, and Duane Hayes for providing a bevy of testing machines.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../" title="Introduction" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Introduction
              </span>
            </div>
          </a>
        
        
          <a href="../Memory-alignment/" title="Memory-alignment" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Memory-alignment
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
    
  </body>
</html>